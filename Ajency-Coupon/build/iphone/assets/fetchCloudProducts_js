var localStorage=require("/localStorage"),alloy=require("alloy"),allProductIdsArray=[],filteredProductArray=[],xhr=Ti.Network.createHTTPClient(),fetchCategories=function(e){alloy.Globals.categoryResponse=[],Ti.App.Properties.removeProperty("allCategoryResponse"),localStorage.saveMultiplierValue(1),Cloud.Objects.query({classname:"categories",limit:1e3,where:{organizationId:localStorage.getOrganizationId()}},function(t){if(t.success){console.log("categories success response"),console.log(t);for(var i=0,a=t.categories.length;a>i;i++){var o=t.categories[i];alloy.Globals.categoryResponse.unshift(o)}localStorage.saveAllCategories(alloy.Globals.categoryResponse),fetchCurrencyLogo(e)}else"menu"===e?Ti.App.fireEvent("errorIndex",{name:"fetchCategories"}):"index"===e?Ti.App.fireEvent("errorOnRegister",{name:"fetchCategories"}):"leftMenu"===e?Ti.App.fireEvent("errorOnFetch",{name:"fetchCategories"}):"alloy"===e?alert("Failed to fetch new Products! Please Click Refresh"):"home"===e&&Ti.App.fireEvent("errorOnHome",{name:"fetchCategories"})})},fetchCurrencyLogo=function(e){Cloud.Photos.query({limit:1e3,where:{organizationId:localStorage.getOrganizationId()}},function(t){if(t.success){var i=t.photos[0];localStorage.saveCurrencyUrl(i.urls.small_240),fetchCloudProducts(e)}else alert("Error:\n"+(t.error&&t.message||JSON.stringify(t)))})},fetchCloudProducts=function(e){console.log("fetch called"),allProductsArray=[],Ti.App.Properties.removeProperty("allProductResponse"),Cloud.Objects.query({classname:"things",limit:1e3},function(t){if(t.success){for(var i=0,a=t.things.length;a>i;i++){var o=t.things[i];allProductsArray.push({imageLargePaths:[{imagePath:o.photo.urls.large_1024}],imagePath:o.photo.urls.small_240,categoryId:o.categoryId,productId:o.id,productName:o.productName,productPrice:o.productPrice,hasDiscount:"false",hasLove:"false",available:o.available,served:o.served,description:" ",promotion:"-",loveCount:" ",availableColors:[],reviews:[]})}localStorage.saveAllProducts(allProductsArray),localStorage.saveCloudProducts(allProductsArray),transactionsOnProductIds(e)}else console.log("the error"),console.log(t),"menu"===e?Ti.App.fireEvent("errorIndex",{name:"fetchCloudProducts"}):"index"===e?Ti.App.fireEvent("errorOnRegister",{name:"fetchCloudProducts"}):"leftMenu"===e?Ti.App.fireEvent("errorOnFetch",{name:"fetchCloudProducts"}):"alloy"===e?alert("Failed to fetch new Products! Please Click Refresh"):"home"===e&&Ti.App.fireEvent("errorOnHome",{name:"fetchCloudProducts"})})},transactionsOnProductIdsGreaterThanThousand=function(e){if(0===allProductIdsArray.length)for(var t=0;len=localStorage.getAllProducts().length,len>t;t++)allProductIdsArray.push(allProductsArray[t].productId);Cloud.Objects.query({classname:"testItems",skip:1e3*localStorage.getMultiplierValue(),limit:1e3,where:{productId:{$in:allProductIdsArray}}},function(t){if(console.log("the count"),t.success)if(1e3===t.testItems.length){var i=t.testItems.concat(localStorage.getTemporaryProducts());Ti.App.Properties.removeProperty("temporaryProducts"),localStorage.saveTemporaryProducts(i);var a=localStorage.getMultiplierValue();a+=1,localStorage.saveMultiplierValue(a),transactionsOnProductIdsGreaterThanThousand(e)}else{var i=t.testItems.concat(localStorage.getTemporaryProducts());Ti.App.Properties.removeProperty("temporaryProducts"),Ti.App.Properties.removeProperty("multiplierValue"),computeQuantityOnProductids(i,e)}else console.log("TRANSACTION IDS PRODUCT"),"menu"===e?Ti.App.fireEvent("errorIndex",{name:"transactionsOnProductIdsGreaterThanThousand"}):"index"===e?Ti.App.fireEvent("errorOnRegister",{name:"transactionsOnProductIdsGreaterThanThousand"}):"leftMenu"===e?(console.log("In left menu"),Ti.App.fireEvent("errorOnFetch",{name:"transactionsOnProductIdsGreaterThanThousand"})):"alloy"===e?alert("Failed to fetch new Products! Please Click Refresh"):"home"===e&&Ti.App.fireEvent("errorOnHome",{name:"transactionsOnProductIdsGreaterThanThousand"})})},transactionsOnProductIds=function(e){if(allProductIdsArray=[],localStorage.getAllProducts()){for(var t=0;len=localStorage.getAllProducts().length,len>t;t++)allProductIdsArray.push(allProductsArray[t].productId);Cloud.Objects.query({classname:"testItems",limit:1e3,where:{productId:{$in:allProductIdsArray}}},function(t){console.log("the count"),t.success?1e3===t.testItems.length?(localStorage.saveTemporaryProducts(t.testItems),transactionsOnProductIdsGreaterThanThousand(e)):computeQuantityOnProductids(t.testItems,e):(console.log("TRANSACTION IDS PRODUCT"),"menu"===e?Ti.App.fireEvent("errorIndex",{name:"transactionsOnProductIds"}):"index"===e?Ti.App.fireEvent("errorOnRegister",{name:"transactionsOnProductIds"}):"leftMenu"===e?(console.log("In left menu"),Ti.App.fireEvent("errorOnFetch",{name:"transactionsOnProductIds"})):"alloy"===e?alert("Failed to fetch new Products! Please Click Refresh"):"home"===e&&Ti.App.fireEvent("errorOnHome",{name:"transactionsOnProductIds"}))})}},computeQuantityOnProductids=function(e,t){filteredProductArray=[],filteredProductArray.length=0;var i,a=_.groupBy(e,function(e){return e.productId}),o=_.keys(a);_.each(o,function(e){i=a[e];var t=_.pluck(i,"quantity"),o=_.reduce(t,function(e,t){return e+t},0);_.each(localStorage.getAllProducts(),function(t){t.productId==e&&o>0&&filteredProductArray.push(t)})}),console.log("the flitered array"),console.log(filteredProductArray),Ti.App.Properties.removeProperty("allProductResponse"),localStorage.saveAllProducts(filteredProductArray),navigateControllers(t)},navigateControllers=function(e){if(alloy.Globals.pushNotificationReceived=!1,"menu"===e)console.log("In menu"),Alloy.createController("menu",{}).getView().open();else if("index"===e){console.log("In index");var t=Alloy.createController("index",{}).getView();t.open()}else"leftMenu"===e?Ti.App.fireEvent("successOnFetch"):"home"===e&&Ti.App.fireEvent("successOnHome")};exports.fetchCategories=fetchCategories,exports.transactionsOnProductIds=transactionsOnProductIds,exports.transactionsOnProductIdsGreaterThanThousand=transactionsOnProductIdsGreaterThanThousand,exports.fetchCloudProducts=fetchCloudProducts;