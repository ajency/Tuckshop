function S4(){return(65536*(1+Math.random())|0).toString(16).substring(1)}function guid(){return S4()+S4()+"-"+S4()+"-"+S4()+"-"+S4()+"-"+S4()+S4()+S4()}function Migrator(e,t){this.db=t,this.dbname=e.adapter.db_name,this.table=e.adapter.collection_name,this.idAttribute=e.adapter.idAttribute,this.column=function(e){var t=e.split(/\s+/),i=t[0];switch(i.toLowerCase()){case"string":case"varchar":case"date":case"datetime":Ti.API.warn('"'+i+'" is not a valid sqlite field, using TEXT instead');case"text":i="TEXT";break;case"int":case"tinyint":case"smallint":case"bigint":case"boolean":Ti.API.warn('"'+i+'" is not a valid sqlite field, using INTEGER instead');case"integer":i="INTEGER";break;case"double":case"float":case"decimal":case"number":Ti.API.warn('"'+e+'" is not a valid sqlite field, using REAL instead');case"real":i="REAL";break;case"blob":i="BLOB";break;case"null":i="NULL";break;default:i="TEXT"}return t[0]=i,t.join(" ")},this.createTable=function(e){var t=[],i=!1;for(var s in e.columns)s===this.idAttribute&&(i=!0),t.push(s+" "+this.column(e.columns[s]));i||this.idAttribute!==ALLOY_ID_DEFAULT||t.push(ALLOY_ID_DEFAULT+" TEXT UNIQUE");var r="CREATE TABLE IF NOT EXISTS "+this.table+" ( "+t.join(",")+")";this.db.execute(r)},this.dropTable=function(){this.db.execute("DROP TABLE IF EXISTS "+this.table)},this.insertRow=function(e){var t=[],i=[],s=[],r=!1;for(var o in e)o===this.idAttribute&&(r=!0),t.push(o),i.push(e[o]),s.push("?");r||this.idAttribute!==ALLOY_ID_DEFAULT||(t.push(this.idAttribute),i.push(guid()),s.push("?")),this.db.execute("INSERT INTO "+this.table+" ("+t.join(",")+") VALUES ("+s.join(",")+");",i)},this.deleteRow=function(e){var t="DELETE FROM "+this.table,i=_.keys(e),s=i.length,r=[],o=[];s&&(t+=" WHERE ");for(var a=0;s>a;a++)r.push(i[a]+" = ?"),o.push(e[i[a]]);t+=r.join(" AND "),this.db.execute(t,o)}}function Sync(e,t,i){var s,r,o=t.config.adapter.collection_name,a=t.config.columns,l=t.config.adapter.db_name||ALLOY_DB_DEFAULT,n=null;switch(e){case"create":case"update":n=function(){var e={};t.id||(t.id=t.idAttribute===ALLOY_ID_DEFAULT?guid():null,e[t.idAttribute]=t.id,t.set(e,{silent:!0}));var i=[],n=[],y=[];for(var d in a)i.push(d),n.push(t.get(d)),y.push("?");if(r="REPLACE INTO "+o+" ("+i.join(",")+") VALUES ("+y.join(",")+");",s=Ti.Database.open(l),s.execute("BEGIN;"),s.execute(r,n),null===t.id){var p="SELECT last_insert_rowid();",c=s.execute(p);c&&c.isValidRow()?(t.id=c.field(0),e[t.idAttribute]=t.id,t.set(e,{silent:!0})):Ti.API.warn("Unable to get ID from database for model: "+t.toJSON()),c&&c.close()}return s.execute("COMMIT;"),s.close(),t.toJSON()}();break;case"read":i.query&&i.id&&Ti.API.warn('Both "query" and "id" options were specified for model.fetch(). "id" will be ignored.'),r="SELECT * FROM "+o,i.query?r=i.query:i.id&&(r+=" WHERE "+(t.idAttribute?t.idAttribute:ALLOY_ID_DEFAULT)+" = "+(_.isString(i.id)?'"'+i.id+'"':i.id)),s=Ti.Database.open(l);var y;y=_.isString(r)?s.execute(r):s.execute(r.statement,r.params);for(var d=0,p=[];y.isValidRow();){var c={},u=0;u=_.isFunction(y.fieldCount)?y.fieldCount():y.fieldCount,_.times(u,function(e){var t=y.fieldName(e);c[t]=y.fieldByName(t)}),p.push(c),d++,y.next()}y.close(),s.close(),t.length=d,n=1===d?p[0]:p;break;case"delete":r="DELETE FROM "+o+" WHERE "+t.idAttribute+"=?",s=Ti.Database.open(l),s.execute(r,t.id),s.close(),t.id=null,n=t.toJSON()}n?(_.isFunction(i.success)&&i.success(n),"read"!==e||i.silent||t.trigger("fetch",{fromAdapter:!0})):_.isFunction(i.error)&&i.error(n)}function GetMigrationFor(e,t){var i=null,s=Ti.Database.open(e);s.execute("CREATE TABLE IF NOT EXISTS migrations (latest TEXT, model TEXT);");var r=s.execute("SELECT latest FROM migrations where model = ?;",t);return r.isValidRow()&&(i=r.field(0)+""),r.close(),s.close(),i}function Migrate(e){var t=e.migrations||[],i={};t.length&&t[t.length-1](i);var s=e.prototype.config;s.adapter.db_name=s.adapter.db_name||ALLOY_DB_DEFAULT;var r=new Migrator(s),o="undefined"==typeof s.adapter.migration||null===s.adapter.migration?i.id:s.adapter.migration;if("undefined"==typeof o||null===o){var a=Ti.Database.open(s.adapter.db_name);return r.db=a,r.createTable(s),void a.close()}o+="";var l,n=GetMigrationFor(s.adapter.db_name,s.adapter.collection_name);if(n!==o){if(n&&n>o?(l=0,t.reverse()):l=1,db=Ti.Database.open(s.adapter.db_name),r.db=db,db.execute("BEGIN;"),t.length)for(var y=0;y<t.length;y++){var d=t[y],p={};if(d(p),l){if(p.id>o)break;if(p.id<=n)continue}else{if(p.id<=o)break;if(p.id>n)continue}var c=l?"up":"down";_.isFunction(p[c])&&p[c](r)}else r.createTable(s);db.execute("DELETE FROM migrations where model = ?",s.adapter.collection_name),db.execute("INSERT INTO migrations VALUES (?,?)",o,s.adapter.collection_name),db.execute("COMMIT;"),db.close(),r.db=null}}function installDatabase(e){var t=e.adapter.db_file,i=e.adapter.collection_name,s=/(^|.*\/)([^\/]+)\.[^\/]+$/,r=t.match(s);if(null===r)throw'Invalid sql database filename "'+t+'"';e.adapter.db_name=e.adapter.db_name||r[2];var o=e.adapter.db_name;Ti.API.debug('Installing sql database "'+t+'" with name "'+o+'"');var a=Ti.Database.install(t,o);!1===e.adapter.remoteBackup&&(Ti.API.debug('iCloud "do not backup" flag set for database "'+t+'"'),a.file.setRemoteBackup(!1));var l,n,y=a.execute('pragma table_info("'+i+'");'),d={};if(y){for(;y.isValidRow();)l=y.fieldByName("name"),n=y.fieldByName("type"),d[l]=n,l!==ALLOY_ID_DEFAULT||e.adapter.idAttribute||(e.adapter.idAttribute=ALLOY_ID_DEFAULT),y.next();y.close()}else{e.adapter.idAttribute?e.adapter.idAttribute:ALLOY_ID_DEFAULT;for(var p in e.columns)l=p,n=e.columns[p],l!==ALLOY_ID_DEFAULT||e.adapter.idAttribute?p===e.adapter.idAttribute&&(n+=" UNIQUE"):e.adapter.idAttribute=ALLOY_ID_DEFAULT,d[l]=n}if(e.columns=d,e.adapter.idAttribute){if(!_.contains(_.keys(e.columns),e.adapter.idAttribute))throw'config.adapter.idAttribute "'+e.adapter.idAttribute+'" not found in list of columns for table "'+i+'"\ncolumns: ['+_.keys(e.columns).join(",")+"]"}else{Ti.API.info('No config.adapter.idAttribute specified for table "'+i+'"'),Ti.API.info('Adding "'+ALLOY_ID_DEFAULT+'" to uniquely identify rows');var c=[],u=[];_.each(e.columns,function(e,t){u.push(t),c.push(t+" "+e)});var h=u.join(",");a.execute("ALTER TABLE "+i+" RENAME TO "+i+"_temp;"),a.execute("CREATE TABLE "+i+"("+c.join(",")+","+ALLOY_ID_DEFAULT+" TEXT UNIQUE);"),a.execute("INSERT INTO "+i+"("+h+","+ALLOY_ID_DEFAULT+") SELECT "+h+",CAST(_ROWID_ AS TEXT) FROM "+i+"_temp;"),a.execute("DROP TABLE "+i+"_temp;"),e.columns[ALLOY_ID_DEFAULT]="TEXT UNIQUE",e.adapter.idAttribute=ALLOY_ID_DEFAULT}a.close()}var _=require("alloy/underscore")._,ALLOY_DB_DEFAULT="_alloy_",ALLOY_ID_DEFAULT="alloy_id",cache={config:{},Model:{}};module.exports.beforeModelCreate=function(e,t){if(cache.config[t])return cache.config[t];if("mobileweb"===Ti.Platform.osname||"undefined"==typeof Ti.Database)throw"No support for Titanium.Database in MobileWeb environment.";return e.adapter.db_file&&installDatabase(e),e.adapter.idAttribute||(Ti.API.info('No config.adapter.idAttribute specified for table "'+e.adapter.collection_name+'"'),Ti.API.info('Adding "'+ALLOY_ID_DEFAULT+'" to uniquely identify rows'),e.columns[ALLOY_ID_DEFAULT]="TEXT UNIQUE",e.adapter.idAttribute=ALLOY_ID_DEFAULT),cache.config[t]=e,e},module.exports.afterModelCreate=function(e,t){return cache.Model[t]?cache.Model[t]:(e=e||{},e.prototype.idAttribute=e.prototype.config.adapter.idAttribute,Migrate(e),cache.Model[t]=e,e)},module.exports.sync=Sync;