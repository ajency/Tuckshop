function __processArg(e,t){var i=null;return e&&(i=e[t]||null,delete e[t]),i}function Controller(){function e(){g.animateObject.image="/images/loaderlogin-"+O+".png",O++,5===O&&(O=1)}function t(){var e=Alloy.createController("register").getView();g.win1.openWindow(e)}function i(e){var t=e.users[0];if(dbOperations.checkIfRowExists(t.id)){dbOperations.onlineLoginStatus(t.id),dbOperations.setOrganizationId(t.id,t.custom_fields.organizationId);var i=dbOperations.getMailStatus(A.getLastLoggedInUserId());null===i.mails&&null===i.daily_weekly&&dbOperations.updateMailStatus(t.id,1,"daily");var n=dbOperations.getLastMailDate(A.getLastLoggedInUserId());null===n&&dbOperations.updateLastMailDate(t.id,t.custom_fields.last_mail_date);var r=dbOperations.getLastMailDate(A.getLastLoggedInUserId());null===r&&dbOperations.updateUserType(t.id,t.admin),t.hasOwnProperty("role")?(console.log("user has a role"),dbOperations.updateUserRole(t.id,t.role)):dbOperations.updateUserRole(t.id,"consumer")}else{var o;t.hasOwnProperty("role")?(console.log("user has a role"),o="cook"):o="consumer",dbOperations.insertRow(t.id,g.usernameTextfield.value,!0,e.meta.session_id,t.custom_fields.credited_date_at,t.custom_fields.organizationId,1,"daily",t.custom_fields.last_mail_date,t.admin,o)}}function n(){Cloud.Users.update({custom_fields:{device_token:deviceToken}},function(e){e.success?(e.users[0],i(e),dbOperations.checkOrganizationPresent(A.getOrganizationId())?d():o()):(E(),clearInterval(b),A.saveErrorAtIndex("updateDeviceToken"),P())})}function r(){Cloud.Users.update({custom_fields:{last_mail_date:L().format(),device_token:deviceToken}},function(e){e.success?(e.users[0],i(e),dbOperations.checkOrganizationPresent(A.getOrganizationId())?d():o()):(E(),clearInterval(b),A.saveErrorAtIndex("updateLastMailDate"),P())})}function o(){Cloud.Objects.query({classname:"organization",limit:1e3,where:{organizationId:A.getOrganizationId()}},function(e){e.success?(dbOperations.saveOrganizationRow(e.organization),d()):(E(),clearInterval(b),type="organizationData",P())})}function a(){g.usernameTextfield.blur(),g.passwordTextfield.blur(),C(),b=setInterval(e,200),x(),g.loginButton.enabled=!1,Cloud.Users.login({login:g.usernameTextfield.value,password:g.passwordTextfield.value},function(e){if(e.success){var t=e.users[0];console.log("User details"),console.log(t),v.Globals.autoLogin=!0,dbOperations.getCount()>1&&v.Globals.forceLogout(),A.saveUserId(t),A.saveUserName(g.usernameTextfield.value),A.saveDisplayName(I[0]),A.saveSessionId(e.meta.session_id),A.saveCreditedDate(t.custom_fields.credited_date_at),A.saveLastLoggedInUserId(t.id),Ti.API.info("test credited date:::\n"+t.custom_fields.credited_date_at),y=L(t.custom_fields.credited_date_at),null!=v.Globals.midContainerReference&&Ti.App.removeEventListener("app:addViewToMidContainer",v.Globals.midContainerReference),null!=v.Globals.navigatePrevious&&Ti.App.removeEventListener("screen:back",v.Globals.navigatePrevious),null!=v.Globals.successOnRefresh&&Ti.App.removeEventListener("successOnFetch",v.Globals.successOnRefresh),null!=v.Globals.toggleLeft&&Ti.App.removeEventListener("menu:toggleLeftMenu",v.Globals.toggleLeft),"ajency.in"===I[1]?A.saveOrganizationId(1):"ascotwm.com"===I[1]&&A.saveOrganizationId(2),t.custom_fields.hasOwnProperty("last_mail_date")?t.custom_fields.device_token!=deviceToken?n():(i(e),dbOperations.checkOrganizationPresent(A.getOrganizationId())?d():o()):(console.log("last mail date called"),r())}else E(),k(),clearInterval(b),alert(401==e.code?"Invalid username and password":"Could not connect to server. Try again "),g.loginButton.enabled=!0})}function s(){if(""!=g.usernameTextfield.value.trim()&&""!=g.passwordTextfield.value.trim())if(I=g.usernameTextfield.value.split("@"),c(g.usernameTextfield.value))if("ajency.in"===I[1]||"ascotwm.com"===I[1])if(0==S.getNetworkStatus())alert("No Internet Connection");else if(A.getOrganizationId())if(dbOperations.checkOrganizationPresent(A.getOrganizationId())){var e=dbOperations.getOrganizationRow(A.getOrganizationId());e[0].domainName===I[1]?a():alert("Sorry your organization is not registered")}else a();else a();else alert("Sorry your organization is not registered"),g.loginButton.enabled=!0;else alert("Please enter a valid email");else alert("Username/Password are required"),g.loginButton.enabled=!0}function l(){var e=dbOperations.getOrganizationRow(A.getOrganizationId()),t=e[0].organizationPendingChannel;Cloud.PushNotifications.subscribeToken({device_token:deviceToken,channel:t,type:"ios"},function(e){e.success?D():(E(),clearInterval(b),A.saveErrorAtIndex("subscribeToPendingChannel"),P())})}function d(){var e=dbOperations.getOrganizationRow(A.getOrganizationId()),t=e[0].organizationPushChannel;Cloud.PushNotifications.subscribeToken({device_token:deviceToken,channel:t,type:"ios"},function(e){e.success?"cook"===dbOperations.getUserRole(A.getLastLoggedInUserId())?(console.log("cook id"),l()):D():(E(),clearInterval(b),A.saveErrorAtIndex("subscribeToChannel"),P(),console.log("SUBSCRIBE CHANNEL"))})}function c(e){var t=e,i=/^([A-Za-z0-9_\-\.])+\@([A-Za-z0-9_\-\.])+\.([A-Za-z]{2,4})$/;return testresults=i.test(t)?!0:!1}function u(){console.log("In do navigation");var e=dbOperations.ifTableExists();if(e.isValidRow()){var t=dbOperations.getCount();switch(Ti.API.info("Row count: "+t),t){case 0:g.win1.open();break;case 1:A.getLastLoggedInUserId()&&!v.Globals.navigatedFromAllProducts?Alloy.createController("menu",{}).getView().open():A.getLastLoggedInUserId()||g.win1.open();break;default:Alloy.createController("multiUser",{}).getView().open()}}}function h(e){deviceToken=e.deviceToken,E(),clearInterval(b),k(),A.saveDeviceToken(e.deviceToken)}function f(){alert("Failed to register for push notifications! "),Ti.App.fireEvent("pushNotificationRegisterError")}require("alloy/controllers/BaseController").apply(this,Array.prototype.slice.call(arguments)),this.__controllerPath="index",arguments[0]&&(__processArg(arguments[0],"__parentSymbol"),__processArg(arguments[0],"$model"),__processArg(arguments[0],"__itemTemplate"));var g=this,p={},m={};g.__views.index=Ti.UI.createWindow({backgroundColor:"transparent",opacity:1,width:Ti.UI.FILL,height:Ti.UI.FILL,layout:"vertical",navBarHidden:!0,exitOnClose:!0,backgroundImage:"/background.jpg",id:"index"}),g.__views.__alloyId50=Ti.UI.createView({layout:"vertical",top:0,height:"80%",id:"__alloyId50"}),g.__views.index.add(g.__views.__alloyId50),g.__views.__alloyId51=Ti.UI.createView({layout:"vertical",width:Ti.UI.FILL,height:Ti.UI.SIZE,top:"5%",id:"__alloyId51"}),g.__views.__alloyId50.add(g.__views.__alloyId51),g.__views.companyLogo=Ti.UI.createImageView({image:"/images/tuckshopLogo.png",width:"45%",height:"29%",id:"companyLogo"}),g.__views.__alloyId51.add(g.__views.companyLogo),g.__views.usernameTextfield=Ti.UI.createTextField({backgroundColor:"#FFF",color:"#222",borderWidth:1,borderColor:"#F0C60A",height:"11%",borderStyle:Titanium.UI.INPUT_BORDERSTYLE_NONE,font:{fontFamily:"OpenSans-Regular",fontSize:18},textAlign:"center",width:"90%",left:"5%",right:"5%",keyboardType:Ti.UI.KEYBOARD_EMAIL,top:"4%",id:"usernameTextfield",hintText:"Username"}),g.__views.__alloyId51.add(g.__views.usernameTextfield),g.__views.passwordTextfield=Ti.UI.createTextField({backgroundColor:"#FFF",color:"#222",borderWidth:1,borderColor:"#F0C60A",height:"11%",borderStyle:Titanium.UI.INPUT_BORDERSTYLE_NONE,font:{fontFamily:"OpenSans-Regular",fontSize:18},textAlign:"center",width:"90%",left:"5%",right:"5%",keyboardType:Titanium.UI.KEYBOARD_NUMBER_PAD,passwordMask:!0,top:"2%",id:"passwordTextfield",hintText:"Password",maxLength:"4"}),g.__views.__alloyId51.add(g.__views.passwordTextfield),g.__views.animateObject=Ti.UI.createImageView({id:"animateObject",height:"0",width:"0",top:"0",image:"/images/loader-1.png"}),g.__views.__alloyId51.add(g.__views.animateObject),g.__views.errorLabel=Ti.UI.createLabel({text:"Tap to Retry",id:"errorLabel",height:"0",width:"0",top:"0"}),g.__views.__alloyId51.add(g.__views.errorLabel),g.__views.loginButton=Ti.UI.createButton({width:"90%",left:"5%",right:"5%",color:"#3B0B0B",backgroundColor:"#F0C60A",title:"Login",height:"11%",font:{fontFamily:"OpenSans-Regular",fontSize:20,fontWeight:"bold"},style:Titanium.UI.iPhone.SystemButtonStyle.PLAIN,id:"loginButton",top:"4%"}),g.__views.__alloyId51.add(g.__views.loginButton),s?g.__views.loginButton.addEventListener("click",s):m["$.__views.loginButton!click!loginClicked"]=!0,g.__views.registerButton=Ti.UI.createButton({font:{fontFamily:"OpenSans-Regular",fontSize:15},top:"10%",width:"70%",left:"15%",right:"15%",color:"#F0C60A",backgroundColor:"#585858",title:"New to Tuckshop? Sign up.",height:"11%",style:Titanium.UI.iPhone.SystemButtonStyle.PLAIN,id:"registerButton"}),g.__views.__alloyId51.add(g.__views.registerButton),t?g.__views.registerButton.addEventListener("click",t):m["$.__views.registerButton!click!openRegister"]=!0,g.__views.__alloyId52=Ti.UI.createView({layout:"horizontal",width:Ti.UI.FILL,bottom:0,height:"20%",id:"__alloyId52"}),g.__views.index.add(g.__views.__alloyId52),g.__views.__alloyId53=Ti.UI.createImageView({width:Ti.UI.FILL,height:Ti.UI.FILL,image:"/images/footer.png",id:"__alloyId53"}),g.__views.__alloyId52.add(g.__views.__alloyId53),g.__views.win1=Ti.UI.iOS.createNavigationWindow({window:g.__views.index,id:"win1"}),g.__views.win1&&g.addTopLevelView(g.__views.win1),p.destroy=function(){},_.extend(g,g.__views);var w=arguments[0]||{},v=require("alloy");require("platformSupport"),require("animation");var I,y,T,b,L=require("alloy/moment");Titanium.UI.iPhone.setAppBadge(null);var A=require("/localStorage"),S=require("/networkCheck"),U=require("/fetchCloudProducts"),O=1,C=function(){g.animateObject.height=96,g.animateObject.width=96},E=function(){g.animateObject.height=0,g.animateObject.width=0},k=function(){g.passwordTextfield.visible=!0,g.usernameTextfield.visible=!0,g.loginButton.visible=!0,g.registerButton.visible=!0},x=function(){g.passwordTextfield.visible=!1,g.usernameTextfield.visible=!1,g.loginButton.visible=!1,g.registerButton.visible=!1},P=function(){g.errorLabel.height="15%",g.errorLabel.width="30%"};if(A.getOrganizationId()&&dbOperations.checkOrganizationPresent(A.getOrganizationId())){var V=dbOperations.getOrganizationRow(A.getOrganizationId());g.companyLogo.image=V[0].organization_logo}A.getErrorAtIndex()?(g.win1.open(),x(),P()):u(),g.errorLabel.addEventListener("click",function(){0==S.getNetworkStatus()?alert("No Internet Connection"):(C(),b=setInterval(e,200),N(),"updateCreditDate"===A.getErrorAtIndex()?D():"updateCreditAmount"===A.getErrorAtIndex()?F():"removeCarryForward"===A.getErrorAtIndex()?R(T):"deviceTokenError"===A.getErrorAtIndex()?CloudPush.retrieveDeviceToken({success:h,error:f}):"updateLastMailDate"===A.getErrorAtIndex()?r():"updateDeviceToken"===A.getErrorAtIndex()?n():"subscribeToChannel"===A.getErrorAtIndex()?d():"subscribeToPendingChannel"===A.getErrorAtIndex()?l():"organizationData"===A.getErrorAtIndex()?o():"fetchCategories"===A.getErrorAtIndex()?U.fetchCategories("menu"):"fetchCloudProducts"===A.getErrorAtIndex()?U.fetchCloudProducts("menu"):"transactionsOnProductIds"===A.getErrorAtIndex()?U.transactionsOnProductIds("menu"):"transactionsOnProductIdsGreaterThanThousand"===A.getErrorAtIndex()?U.transactionsOnProductIdsGreaterThanThousand("menu"):"pushRegisterError"===A.getErrorAtIndex()&&Ti.Network.registerForPushNotifications({types:[Ti.Network.NOTIFICATION_TYPE_BADGE,Ti.Network.NOTIFICATION_TYPE_ALERT,Ti.Network.NOTIFICATION_TYPE_SOUND],success:h,error:f,callback:receivePush}),Ti.App.Properties.removeProperty("errorAtIndex"))});var N=function(){g.errorLabel.height=0,g.errorLabel.width=0};Ti.App.addEventListener("errorIndex",function(e){console.log("Error event fired"),E(),clearInterval(b),A.saveErrorAtIndex(e.name),P()}),0!=Object.keys(w).length?g.usernameTextfield.value=w.title:A.getUserName()&&(g.usernameTextfield.value=A.getUserName()),g.passwordTextfield.addEventListener("return",function(){s()});var D=function(){T=0,createdDateValue=y.add("months",1),Ti.API.info("Created Date:::\n"+L(createdDateValue).format()),Ti.API.info("Minutes remaining:::\n"+L().diff(createdDateValue,"minutes")),L().diff(createdDateValue,"minutes")>0?Cloud.Users.update({custom_fields:{credited_date_at:L(createdDateValue).format()}},function(e){if(e.success){var t=e.users[0];_.each(dbOperations.getAllTransactionRows(A.getLastLoggedInUserId()),function(e){T+=parseFloat(e.productPrice)}),console.log("The Sum after a month"),console.log(T),dbOperations.updateCreditDate(t.id,t.custom_fields.credited_date_at),0>T?F():R(T)}else E(),clearInterval(b),A.saveErrorAtIndex("updateCreditDate"),P(),console.log("UPDATE CREDIT DATE")}):A.getAllProducts()||v.Globals.pushNotificationReceived?(Ti.App.fireEvent("destroy:menu:instance"),Alloy.createController("menu",{}).getView().open(),E(),clearInterval(b)):U.fetchCategories("menu")},R=function(e){Cloud.Objects.create({classname:"testItems",fields:{productName:"Debit balance",productPrice:-e,productId:1010,userId:A.getUserId()}},function(e){e.success?(console.log("Amount carry forward in index"),e.testItems[0],dbOperations.saveTransactionRows(e.testItems),F()):(E(),clearInterval(b),A.saveErrorAtIndex("removeCarryForward"),P(),console.log("CARRY FORWARD AMOUNT"))})},F=function(){Cloud.Objects.create({classname:"testItems",fields:{productName:"Credit",productPrice:500,productId:1010,userId:A.getUserId()}},function(e){e.success?(console.log("Amount credited in index"),e.testItems[0],dbOperations.saveTransactionRows(e.testItems),A.getAllProducts()?(Alloy.createController("menu",{}).getView().open(),E(),clearInterval(b)):U.fetchCategories("menu")):(E(),clearInterval(b),A.saveErrorAtIndex("updateCreditAmount"),P(),console.log("UPDATE CREDIT AMOUNT"))})};Ti.App.addEventListener("pushNotificationRegisterError",function(){A.saveErrorAtIndex("pushRegisterError"),P(),x()}),g.win1.addEventListener("close",function(){g.destroy(),g.off(),g.win1.close()}),m["$.__views.loginButton!click!loginClicked"]&&g.__views.loginButton.addEventListener("click",s),m["$.__views.registerButton!click!openRegister"]&&g.__views.registerButton.addEventListener("click",t),_.extend(g,p)}var Alloy=require("alloy"),Backbone=Alloy.Backbone,_=Alloy._;module.exports=Controller;