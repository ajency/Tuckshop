function __processArg(e,t){var i=null;return e&&(i=e[t]||null,delete e[t]),i}function Controller(){function e(){v.image="/images/loader-"+C+".png",C++,5===C&&(C=1)}function t(){p.productsTable.data=empty,p.productsTable.data=S}function n(e){A.getCookToken()?r(e):Cloud.Users.query({limit:1e3,where:{$and:[{role:"cook"},{organizationId:A.getOrganizationId()}]}},function(t){if(t.success){var i=t.users[0];console.log("Cook details"),console.log(i),A.saveCookToken(i.custom_fields.device_token),r(e)}else p.productsTable.updateRow(e.index,c(e,"retrieveCookId"))})}function r(e){var t=dbOperations.getOrganizationRow(A.getOrganizationId()),i=t[0].organizationPendingChannel;enteredEmailValue=dbOperations.getUserName(A.getLastLoggedInUserId()).split("@"),Cloud.PushNotifications.notifyTokens({channel:i,to_tokens:A.getCookToken(),payload:{alert:enteredEmailValue[0]+" ordered "+e.rowData.name,message:{name:enteredEmailValue[0]+" ordered "+e.rowData.name,date:E().format("L")},custom_property:"order"}},function(t){t.success?(clearInterval(y),p.productsTable.updateRow(e.index,h(e))):p.productsTable.updateRow(e.index,c(e,"pendingPushNotification"))})}function o(e){var t=dbOperations.getDailyTransactions(A.getLastLoggedInUserId(),dbOperations.getLastMailDate(A.getLastLoggedInUserId()),E.utc().format());console.log(t);var r=[],o=[],a=[];for(i=0;i<t.length;i++)r.unshift(t[i].productName),o.unshift(t[i].productPrice),a.unshift(E(t[i].updated_at).format("L"));var s="<table><tr><td style='width: 100px; text-align: center;'>Product Name</td>";for(s+="<td style='width: 100px; text-align: center;'>Product Price</td>",s+="<td style='width: 100px; text-align: center;'>Date</td></tr>",i=0;i<t.length;i++)s+="<tr><td style='width: 100px; text-align: center;'>"+r[i]+"</td>",s+="<td style='width: 100px; text-align: center;'>"+o[i]+"</td>",s+="<td style='width: 100px; text-align: center;'>"+a[i]+"</td></tr>";s+="</table>",Cloud.Emails.send({template:"Daily Purchase",recipients:dbOperations.getUserName(A.getLastLoggedInUserId()),displayName:A.getDisplayName(),structure:s},function(t){t.success?(dbOperations.updateLastMailDate(A.getLastLoggedInUserId(),E().format()),L?(console.log("Cheese sandwich bought"),n(e)):(clearInterval(y),p.productsTable.updateRow(e.index,h(e)))):p.productsTable.updateRow(e.index,c(e,"sendEmail"))})}function a(e){Cloud.Users.update({custom_fields:{last_mail_date:E().format()}},function(t){t.success?(t.users[0],o(e)):p.productsTable.updateRow(e.index,c(e,"updateLastMailDate"))})}function s(e){var t=E().diff(dbOperations.getLastMailDate(A.getLastLoggedInUserId())),i=E.duration(t).asHours();console.log("minutes"),console.log(i);var r=dbOperations.getMailStatus(A.getLastLoggedInUserId());E.duration(t).asHours()>24&&1===r.mails?(console.log("Send mails"),a(e)):L?(console.log("Cheese sandwich bought"),n(e)):(clearInterval(y),p.productsTable.updateRow(e.index,h(e)))}function l(e){var t=0;_.each(e,function(e){t+=parseFloat(e.productPrice)}),t=t.toFixed(2),Ti.App.fireEvent("Calculate",{value:t})}function d(e,t){var i=dbOperations.getCount();Ti.API.info("Row count: "+i);var n=dbOperations.getLoginStatus(A.getLastLoggedInUserId());n?I.Globals.autoLogin?(console.log("App not closed"),g=E(dbOperations.getLastCreditDate(A.getLastLoggedInUserId())),console.log("day"),console.log(g),D(e,t),p.productsTable.updateRow(t.index,u(t))):F(e,t):1===i?(I.Globals.navigatedFromAllProducts=!0,Alloy.createController("index",{}).getView().open()):i>1&&Alloy.createController("multiUser",{}).getView().open()}function c(e,t){b=!0;var i=Ti.UI.createTableViewRow({id:"swipeRow",height:70,focusable:!0,backgroundSelectedColor:"white"}),s=Ti.UI.createView({layout:"horizontal",height:Ti.UI.FILL,width:Ti.UI.FILL,backgroundColor:"#F0C60A"}),l=Ti.UI.createLabel({text:"Tap to Retry",font:{fontFamily:"OpenSans-Regular",fontSize:15,fontWeight:"bold"},top:20,left:"40%",textAlign:"center"});return i.addEventListener("click",function(){0==U.getNetworkStatus()?alert("No Internet Connection"):("fetchDelta"===t?O(e):"makeEntry"===t?V(e.rowData.id,e):"updateCreditDate"===t?D(e.rowData.id,e):"updateCreditAmount"===t?P(e.rowData.id,e):"removeCarryForward"===t?N(w,e.rowData.id,e):"updateLastMailDate"===t?a(e):"sendEmail"===t?o(e):"pendingPushNotification"===t?r(e):"retrieveCookId"===t&&n(e),p.productsTable.updateRow(e.index,u(e)))}),s.add(l),i.add(s),i}function u(){var t=Ti.UI.createTableViewRow({id:"swipeRow",height:70,focusable:!0,backgroundSelectedColor:"transparent"}),i=Ti.UI.createView({layout:"horizontal",height:Ti.UI.FILL,width:Ti.UI.FILL,backgroundColor:"#F0C60A"});return v=Ti.UI.createImageView({left:"45%",top:"15",height:40,width:48}),i.add(v),y=setInterval(e,200),t.add(i),t}function h(){function e(i){i.cancelBubble=!0,t(),a.removeEventListener("click",e)}var i=Ti.UI.createTableViewRow({id:"swipeRow",height:70,focusable:!0,backgroundSelectedColor:"transparent"}),n=Ti.UI.createView({layout:"horizontal",height:Ti.UI.FILL,width:Ti.UI.FILL,backgroundColor:"#3B0B0B"}),r=Ti.UI.createView({left:"10%",layout:"horizontal",height:Ti.UI.SIZE,width:"55%"}),o=Ti.UI.createLabel({left:0,text:"Purchase Successful",color:"#F0C60A",font:{fontFamily:"OpenSans-Regular",fontSize:20}});r.add(o);var a=Ti.UI.createView({layout:"horizontal",height:Ti.UI.SIZE,width:"35%"}),s=Ti.UI.createView({left:0,top:"12.5%",bottom:"12.5%",height:"75%",width:"1%",backgroundColor:"#F0C60A"}),l=Ti.UI.createImageView({left:"10%",height:30,width:30,image:"/images/icon_tick.png"}),d=Ti.UI.createLabel({left:"2%",text:"OK",color:"#F0C60A",font:{fontFamily:"OpenSans-Regular",fontSize:20}});return a.add(s),a.add(l),a.add(d),a.addEventListener("click",e),n.add(r),n.add(a),i.add(n),i}function f(e){function i(t){t.cancelBubble=!0,console.log(e.rowData.id),0==U.getNetworkStatus()?alert("No Internet Connection"):(d(e.rowData.id,e),c.removeEventListener("click",n),a.removeEventListener("click",i))}function n(e){e.cancelBubble=!0,t(),a.removeEventListener("click",i),c.removeEventListener("click",n)}var r=Ti.UI.createTableViewRow({id:"swipeRow",height:70,focusable:!0,backgroundSelectedColor:"transparent"}),o=Ti.UI.createView({layout:"horizontal",height:Ti.UI.FILL,width:Ti.UI.FILL,backgroundColor:"#F0C60A"}),a=Ti.UI.createView({left:"10%",layout:"horizontal",height:Ti.UI.SIZE,width:"55%"}),s=Ti.UI.createLabel({left:0,text:"BUY",color:"#444444",font:{fontFamily:"OpenSans-Regular",fontSize:20,fontWeight:"bold"}}),l=Ti.UI.createImageView({left:"2%",height:40,width:40,image:"/images/icon_buy.png"});a.add(s),a.add(l);var c=Ti.UI.createView({layout:"horizontal",height:Ti.UI.SIZE,width:"35%"}),u=Ti.UI.createView({left:0,top:"12.5%",bottom:"12.5%",height:"75%",width:"1%",backgroundColor:"#444444"}),h=Ti.UI.createImageView({left:"10%",height:30,width:30,image:"/images/icon_cancel.png"}),_=Ti.UI.createLabel({left:"2%",text:"Cancel",color:"#444444",font:{fontFamily:"OpenSans-Regular",fontSize:15}});return c.add(u),c.add(h),c.add(_),a.addEventListener("click",i),c.addEventListener("click",n),o.add(a),o.add(c),r.add(o),r}require("alloy/controllers/BaseController").apply(this,Array.prototype.slice.call(arguments)),this.__controllerPath="allProducts",arguments[0]&&(__processArg(arguments[0],"__parentSymbol"),__processArg(arguments[0],"$model"),__processArg(arguments[0],"__itemTemplate"));var p=this,m={};p.__views.allProducts=Ti.UI.createView({layout:"vertical",id:"allProducts"}),p.__views.allProducts&&p.addTopLevelView(p.__views.allProducts),p.__views.productsTable=Ti.UI.createTableView({width:Ti.UI.FILL,height:Ti.UI.FILL,id:"productsTable",separatorColor:"#F0C60A"}),p.__views.allProducts.add(p.__views.productsTable),p.__views.animateObject=Ti.UI.createImageView({id:"animateObject",height:"0",width:"0",top:"0"}),p.__views.allProducts.add(p.__views.animateObject),m.destroy=function(){},_.extend(p,p.__views);var g,w,y,v,I=require("alloy"),T=arguments[0]||{},b=!1,L=!1,S=empty=tempTableData=[],A=require("/localStorage"),U=require("/networkCheck"),E=require("alloy/moment"),C=1,k=_.filter(A.getAllProducts(),function(e){return e.categoryId==T.categoryId}),x=function(e){console.log("Length of table"),console.log(_.size(p.productsTable.data));for(var t=view=imageView=productNameLabel=priceLabel=null,i=0;len=_.size(e),len>i;i++)t=Ti.UI.createTableViewRow({id:e[i].productId,name:e[i].productName,height:70,backgroundSelectedColor:"transparent",backgroundColor:"white"}),productNameLabel=Ti.UI.createLabel({touchEnabled:!1,left:"10%",textAlign:"left",text:e[i].productName,color:"#3B0B0B",font:{fontFamily:"OpenSans-Regular",fontSize:20}}),view=Ti.UI.createView({layout:"horizontal",right:0,height:Ti.UI.SIZE,width:"20%",align:"center"}),imageView=Ti.UI.createImageView({image:A.getCurrencyUrl(),width:15,height:15,top:10,right:0}),priceLabel=Ti.UI.createLabel({touchEnabled:!1,top:"10%",right:0,text:e[i].productPrice,color:"#3B0B0B",font:{fontFamily:"OpenSans-Regular",fontSize:20}}),view.add(imageView),view.add(priceLabel),t.add(productNameLabel),t.add(view),S.push(t),t=view=imageView=productNameLabel=priceLabel=null;p.productsTable.data=S};x(k),p.productsTable.setSeparatorInsets({left:0});var O=function(e){Cloud.Objects.query({classname:"testItems",limit:1e3,where:{$and:[{userId:A.getLastLoggedInUserId()},{updated_at:{$gt:dbOperations.getLatestTransactionDate(A.getLastLoggedInUserId())}}]}},function(t){t.success?(t.testItems.length>0&&dbOperations.saveTransactionRows(t.testItems),s(e),l(dbOperations.getAllTransactionRows(A.getLastLoggedInUserId()))):p.productsTable.updateRow(e.index,c(e,"fetchDelta"))})},V=function(e,t){var i=_.filter(k,function(t){return t.productId===e});L="yes"===i[0].served?!0:!1,Cloud.Objects.create({classname:"testItems",fields:{productName:i[0].productName,productPrice:-i[0].productPrice,productId:i[0].productId,userId:A.getUserId(),quantity:-1}},function(e){e.success?(b=!1,e.testItems[0],O(t)):p.productsTable.updateRow(t.index,c(t,"makeEntry"))})},D=function(e,t){w=0,createdDateValue=g.add("months",1),E().diff(createdDateValue,"minutes")>0?Cloud.Users.update({custom_fields:{credited_date_at:E(createdDateValue).format()}},function(i){if(i.success){var n=i.users[0];_.each(dbOperations.getAllTransactionRows(A.getLastLoggedInUserId()),function(e){w+=parseFloat(e.productPrice)}),console.log("In all products"),console.log(n),console.log(n.credited_date_at),dbOperations.updateCreditDate(n.id,n.custom_fields.credited_date_at),0>w?P(e,t):N(w,e,t)}else p.productsTable.updateRow(t.index,c(t,"updateCreditDate"))}):V(e,t)},N=function(e,t,i){Cloud.Objects.create({classname:"testItems",fields:{productName:"Debit balance",productPrice:-e,productId:1010,userId:A.getUserId()}},function(e){e.success?(console.log("Amount carry forward in index"),e.testItems[0],P(t,i)):p.productsTable.updateRow(i.index,c(i,"removeCarryForward"))})},P=function(e,t){Cloud.Objects.create({classname:"testItems",fields:{productName:"Credit",productPrice:500,productId:1010,userId:A.getUserId()}},function(i){i.success?V(e,t):p.productsTable.updateRow(t.index,c(t,"updateCreditAmount"))})},F=function(e,t){null!=dbOperations.getSessionId(A.getLastLoggedInUserId())?(p.productsTable.updateRow(t.index,u(t)),Cloud.sessionId=A.getSessionId(),Cloud.Users.showMe(function(i){if(i.success){var n=i.users[0];console.log("Logged in"),g=E(n.custom_fields.credited_date_at),D(e,t)}else{var r=Ti.UI.createNotification({message:"Auto Login failed. Please Login again",duration:Ti.UI.NOTIFICATION_DURATION_LONG});r.show(),Alloy.createController("index",{}).getView().open()}})):Alloy.createController("index",{}).getView().open()};p.productsTable.addEventListener("click",function(e){e.rowData&&"swipeRow"!=e.rowData.id&&(t(),p.productsTable.updateRow(e.index,f(e)))}),_.extend(p,m)}var Alloy=require("alloy"),Backbone=Alloy.Backbone,_=Alloy._;module.exports=Controller;