var localStorage=require("/localStorage"),moment=require("alloy/moment"),createDB=function(){var e=Ti.Database.open("TuckshopDatabase");e.execute("CREATE TABLE IF NOT EXISTS users (user_id INTEGER, user_name TEXT, login_status BOOlEAN, session_id INTEGER, last_credit_date TEXT)"),e.execute("CREATE TABLE IF NOT EXISTS transactions (txn_id INTEGER UNIQUE, user_id INTEGER, updated_at TEXT, productName TEXT, productPrice TEXT, productId INTEGER, quantity INTEGER)"),e.execute("CREATE TABLE IF NOT EXISTS organizations (organizationId INTEGER UNIQUE, organizationName TEXT, organization_logo TEXT, organizationPushChannel TEXT, organizationPendingChannel TEXT, domainName TEXT)"),e.close()},addColumn=function(){var e=getDB(),t=!1;for(resultSet=e.execute("PRAGMA TABLE_INFO(users)");resultSet.isValidRow();)"organizationId"==resultSet.field(1)&&(t=!0),resultSet.next();t||(e.execute("ALTER TABLE users ADD COLUMN organizationId INTEGER"),e.execute("ALTER TABLE users ADD COLUMN last_mail_date TEXT"),e.execute("ALTER TABLE users ADD COLUMN admin TEXT"),e.execute("ALTER TABLE users ADD COLUMN role TEXT"),e.execute("ALTER TABLE users ADD COLUMN mails INTEGER"),e.execute("ALTER TABLE users ADD COLUMN daily_weekly TEXT")),e.close()},getDB=function(){var e=Ti.Database.open("TuckshopDatabase");return e},checkIfRowExists=function(e){var t=getDB(),i=t.execute("SELECT * FROM users WHERE user_id = ?",e),a=i;return a.isValidRow()?(i.close(),t.close(),!0):(i.close(),t.close(),!1)},insertRow=function(e,t,i,a,s,o,r,l,n,d,y){var g=getDB();g.execute("INSERT INTO users (user_id, user_name, login_status, session_id, last_credit_date, organizationId, mails, daily_weekly, last_mail_date, admin, role) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)",e,t,i,a,s,o,r,l,moment.utc(n).format(),d,y),g.close()},getCount=function(){var e=getDB(),t=e.execute("SELECT COUNT(*) AS totalUsers FROM users"),i=t.fieldByName("totalUsers");return t.close(),e.close(),i},ifTableExists=function(e){var e=getDB(),t=e.execute('SELECT name FROM sqlite_master WHERE type="table" AND name="users"');return e.close(),t},getMailStatus=function(e){var t=getDB(),i=t.execute("SELECT mails,daily_weekly FROM users WHERE user_id=?",[e]),a={mails:i.fieldByName("mails"),daily_weekly:i.fieldByName("daily_weekly")};return i.close(),t.close(),a},getLoginStatus=function(e){var t=getDB(),i=t.execute("SELECT login_status FROM users WHERE user_id=?",[e]),a=i.fieldByName("login_status");return i.close(),t.close(),a},setOrganizationId=function(e,t){console.log("Setting organization id");var i=getDB();i.execute("UPDATE users SET organizationId=? WHERE user_id=?",t,e),i.close()},updateMailStatus=function(e,t,i){var a=getDB();a.execute("UPDATE users SET mails=?, daily_weekly=? WHERE user_id=?",t,i,e),a.close()},onlineLoginStatus=function(e){var t=getDB();t.execute("UPDATE users SET login_status=? WHERE user_id=?",!0,e),t.close()},offlineLoginStatus=function(e){var t=getDB();t.execute("UPDATE users SET login_status=? WHERE user_id=?",!1,e),t.close()},getSessionId=function(e){var t=getDB(),i=t.execute("SELECT session_id FROM users WHERE user_id=?",[e]),a=i.fieldByName("session_id");return i.close(),t.close(),a},updateSessionId=function(e){var t=getDB();t.execute("UPDATE users SET session_id=? WHERE user_id=?","",e),t.close()},getUsersInfo=function(){for(var e=[],t=getDB(),i=t.execute("SELECT * FROM users");i.isValidRow();)e.push({id:i.fieldByName("user_id"),username:i.fieldByName("user_name")}),i.next();return i.close(),t.close(),e},deleteUser=function(e){var t=getDB();t.execute("DELETE FROM users WHERE user_id=?",e),t.close()},logoutUsers=function(){var e=getDB();e.execute("UPDATE users SET login_status=?",!1),e.close()},updateCreditDate=function(e,t){var i=getDB();i.execute("UPDATE users SET last_credit_date=? WHERE user_id=?",t,e),i.close()},getLastCreditDate=function(e){var t=getDB(),i=t.execute("SELECT last_credit_date FROM users WHERE user_id=?",e),a=i.fieldByName("last_credit_date");return i.close(),t.close(),a},updateLastMailDate=function(e,t){var i=getDB();i.execute("UPDATE users SET last_mail_date=? WHERE user_id=?",moment.utc(t).format(),e),i.close()},getLastMailDate=function(e){var t=getDB(),i=t.execute("SELECT last_mail_date FROM users WHERE user_id=?",e),a=i.fieldByName("last_mail_date");return i.close(),t.close(),a},updateUserType=function(e,t){var i=getDB();i.execute("UPDATE users SET admin=? WHERE user_id=?",t,e),i.close()},getUserType=function(e){var t=getDB(),i=t.execute("SELECT admin FROM users WHERE user_id=?",e),a=i.fieldByName("admin");return i.close(),t.close(),a},getUserName=function(e){var t=getDB(),i=t.execute("SELECT user_name FROM users WHERE user_id=?",e),a=i.fieldByName("user_name");return i.close(),t.close(),a},updateUserRole=function(e,t){var i=getDB();i.execute("UPDATE users SET role=? WHERE user_id=?",t,e),i.close()},getUserRole=function(e){var t=getDB(),i=t.execute("SELECT role FROM users WHERE user_id=?",e),a=i.fieldByName("role");return i.close(),t.close(),a},getTxnCount=function(){var e=getDB(),t=e.execute("SELECT COUNT(*) AS totalUsers FROM transactions"),i=t.fieldByName("totalUsers");return t.close(),e.close(),i},saveTransactionRows=function(e){var t=getDB();e.reverse();for(var i=0,a=e.length;a>i;i++)t.execute("INSERT OR REPLACE INTO transactions (txn_id, user_id, updated_at, productName, productPrice, productId, quantity ) VALUES (?, ?, ?, ?, ?, ?, ?)",e[i].id,localStorage.getLastLoggedInUserId(),e[i].updated_at,e[i].productName,e[i].productPrice,e[i].productId,e[i].quantity);t.close()},checkTransactionsPresentForUser=function(e){var t=getDB(),i=t.execute("SELECT * FROM transactions WHERE user_id = ?",e);return i.isValidRow()?(i.close(),t.close(),!0):(i.close(),t.close(),!1)},getAllTransactionRows=function(e){for(var t=getDB(),i=[],a=t.execute("SELECT * FROM transactions WHERE user_id=?",e);a.isValidRow();)i.push({updated_at:a.fieldByName("updated_at"),productName:a.fieldByName("productName"),productPrice:a.fieldByName("productPrice")}),a.next();return a.close(),t.close(),i.reverse()},getLatestTransactionDate=function(e){var t=getDB(),i=t.execute("SELECT * FROM transactions WHERE user_id =? ORDER BY updated_at DESC LIMIT 1",e),a=i.fieldByName("updated_at");return i.close(),t.close(),a},getDailyTransactions=function(e,t,i){moment().startOf("day"),moment().endOf("day");for(var a=[],s=getDB(),o=s.execute("SELECT * FROM transactions WHERE user_id =? AND updated_at BETWEEN ? AND ?",e,t,i);o.isValidRow();)a.push({productName:o.fieldByName("productName"),productPrice:o.fieldByName("productPrice"),updated_at:o.fieldByName("updated_at")}),o.next();return o.close(),s.close(),a},saveOrganizationRow=function(e){var t=getDB();console.log("data passed"),console.log(e);for(var i=0,a=e.length;a>i;i++)console.log("In loop"),t.execute("INSERT OR REPLACE INTO organizations (organizationId, organizationName, organization_logo, organizationPushChannel, organizationPendingChannel, domainName) VALUES (?, ?, ?, ?, ?, ?)",e[i].organizationId,e[i].organizationName,e[i].photo.urls.small_240,e[i].organizationPushChannel,e[i].organizationPendingChannel,e[i].domainName);t.close()},getOrganizationRow=function(){var e=getDB(),t=[],i=e.execute("SELECT * FROM organizations");for(console.log("rows"),console.log(i);i.isValidRow();)t.push({organizationId:i.fieldByName("organizationId"),organizationName:i.fieldByName("organizationName"),organization_logo:i.fieldByName("organization_logo"),organizationPushChannel:i.fieldByName("organizationPushChannel"),organizationPendingChannel:i.fieldByName("organizationPendingChannel"),domainName:i.fieldByName("domainName")}),i.next();return i.close(),e.close(),t},checkOrganizationPresent=function(e){var t=getDB(),i=t.execute("SELECT * FROM organizations WHERE organizationId = ?",e);return i.isValidRow()?(i.close(),t.close(),!0):(i.close(),t.close(),!1)};exports.createDB=createDB,exports.addColumn=addColumn,exports.checkIfRowExists=checkIfRowExists,exports.insertRow=insertRow,exports.getCount=getCount,exports.ifTableExists=ifTableExists,exports.setOrganizationId=setOrganizationId,exports.updateMailStatus=updateMailStatus,exports.getMailStatus=getMailStatus,exports.getLoginStatus=getLoginStatus,exports.onlineLoginStatus=onlineLoginStatus,exports.offlineLoginStatus=offlineLoginStatus,exports.getSessionId=getSessionId,exports.updateSessionId=updateSessionId,exports.getUsersInfo=getUsersInfo,exports.deleteUser=deleteUser,exports.logoutUsers=logoutUsers,exports.updateCreditDate=updateCreditDate,exports.getLastCreditDate=getLastCreditDate,exports.updateLastMailDate=updateLastMailDate,exports.getLastMailDate=getLastMailDate,exports.updateUserType=updateUserType,exports.getUserType=getUserType,exports.getUserName=getUserName,exports.updateUserRole=updateUserRole,exports.getUserRole=getUserRole,exports.getTxnCount=getTxnCount,exports.saveTransactionRows=saveTransactionRows,exports.checkTransactionsPresentForUser=checkTransactionsPresentForUser,exports.getAllTransactionRows=getAllTransactionRows,exports.getLatestTransactionDate=getLatestTransactionDate,exports.getDailyTransactions=getDailyTransactions,exports.saveOrganizationRow=saveOrganizationRow,exports.getOrganizationRow=getOrganizationRow,exports.checkOrganizationPresent=checkOrganizationPresent;